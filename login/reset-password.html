<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Bus Fleet Management</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <link rel="stylesheet" href="../styles/toast_loader.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
</head>

<body class="auth-body">
    <div class="loader-overlay">
        <div class="loader"></div>
    </div>
    <div class="toast-container"></div>

    <div class="auth-container">
        <div class="auth-header">
            <div class="auth-logo">B</div>
            <div class="auth-title">Reset Password</div>
        </div>

        <!-- Form -->
        <input type="password" id="new-password" class="auth-input" placeholder="New Password" />
        <input type="password" id="confirm-password" class="auth-input" placeholder="Confirm New Password" />

        <button onclick="resetPassword()" class="auth-btn">
            Update Password
        </button>
    </div>

    <script src="../homepage/interactive-bg.js"></script>
    <script>
        async function resetPassword() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!token) {
                showToast('Invalid reset token', 'error');
                return;
            }
            if (!newPassword || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            showLoading(true);
            try {
                const res = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, newPassword })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                } else {
                    showToast(data.error || 'Reset failed', 'error');
                }
            } catch (e) {
                showToast('Error connecting to server', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showToast(message, type = 'success') {
            const container = document.querySelector('.toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i><span>${message}</span>`;
            container.appendChild(toast);
            toast.offsetHeight;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }
        function showLoading(show) {
            const loader = document.querySelector('.loader-overlay');
            if (loader) show ? loader.classList.add('active') : loader.classList.remove('active');
        }
    </script>
</body>

</html>